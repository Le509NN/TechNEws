name: Agent HTML Edit

on:
  workflow_dispatch:
    inputs:
      file:
        description: "Path to the file to edit"
        required: true
        default: "index.html"
      instructions:
        description: "Describe the change to apply"
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  edit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install OpenAI SDK
        run: pip install openai==1.*

      - name: Apply agent edit
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FILE_PATH: ${{ github.event.inputs.file }}
          INSTRUCTIONS: ${{ github.event.inputs.instructions }}
        run: |
          python - <<'PY'
          import os, pathlib
          from openai import OpenAI

          p = pathlib.Path(os.environ["FILE_PATH"])
          if not p.exists():
              raise SystemExit(f"File not found: {p}")

          original = p.read_text(encoding="utf-8")
          instructions = os.environ["INSTRUCTIONS"]

          system = "You are a meticulous web editor. Output ONLY the full, final file contentâ€”no commentary."
          user = (
              "Edit the file below according to the instructions.\n\n"
              f"FILE_PATH: {p}\n"
              "BEGIN_FILE\n"
              f"{original}\n"
              "END_FILE\n\n"
              f"INSTRUCTIONS:\n{instructions}\n"
          )

          client = OpenAI()
          resp = client.chat.completions.create(
              model="gpt-5",
              messages=[{"role":"system","content":system},
                        {"role":"user","content":user}],
              temperature=0
          )
          new_content = resp.choices[0].message.content
          p.write_text(new_content, encoding="utf-8")
          PY

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Agent edit: ${{ github.event.inputs.instructions }}"
          title: "Agent: ${{ github.event.inputs.instructions }}"
          body: |
            Automated change via Agent workflow.
            **File:** ${{ github.event.inputs.file }}
            **Instructions:** ${{ github.event.inputs.instructions }}
          branch: "agent/edit-${{ github.run_id }}"
          labels: "agent-edit"
          delete-branch: true
